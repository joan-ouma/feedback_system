<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Campus Mental Health Support</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <!-- Mobile Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebar-overlay"></div>
    
    <!-- Mobile Sidebar -->
    <div class="mobile-sidebar" id="mobile-sidebar">
        <div class="sidebar-header">
            <a href="/dashboard" class="logo">Campus Support</a>
        </div>
        <nav class="sidebar-nav">
            <a href="/dashboard" class="active">üìä Dashboard</a>
            <a href="/mood">üòä Mood Tracking</a>
            <a href="/quizzes">üìù Quizzes</a>
            <a href="/consultation">üí¨ Consultation</a>
            <button hx-post="/logout" hx-target="body" class="btn-secondary">üö™ Logout</button>
        </nav>
    </div>
    
    <nav class="navbar">
        <div class="container">
            <button class="menu-toggle" id="menu-toggle" aria-label="Toggle menu">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <a href="/dashboard" class="logo">Campus Support</a>
            <div class="nav-links">
                <a href="/dashboard">Dashboard</a>
                <a href="/mood">Mood Tracking</a>
                <a href="/quizzes">Quizzes</a>
                <a href="/consultation">Consultation</a>
                <button hx-post="/logout" hx-target="body" class="btn-secondary">Logout</button>
            </div>
        </div>
    </nav>
    
    <main class="container">
        <div class="dashboard-header">
            <h1>Your Dashboard</h1>
            <p>Submit anonymous feedback or consult with our AI counselor</p>
        </div>
        
        <!-- Quiz Results Summary on Dashboard -->
        {{if .QuizHistory}}
        <div class="card" style="margin-bottom: 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; box-shadow: 0 8px 24px rgba(102,126,234,0.3);">
            <h2 style="margin-top: 0; color: white; margin-bottom: 20px; font-size: 24px; text-align: center;">üìä Your Mental Health Assessment Results</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                {{$moodItem := index .QuizHistory "mood_assessment"}}
                {{$stressItem := index .QuizHistory "stress_level"}}
                {{$anxietyItem := index .QuizHistory "anxiety_check"}}
                {{$wellnessItem := index .QuizHistory "wellness"}}
                
                {{if or (and $moodItem $moodItem.Response) (and $stressItem $stressItem.Response) (and $anxietyItem $anxietyItem.Response) (and $wellnessItem $wellnessItem.Response)}}
                    {{if and $moodItem $moodItem.Response}}
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; backdrop-filter: blur(10px);">
                            <h4 style="margin: 0 0 10px 0; color: white; font-size: 16px;">üìä Mood</h4>
                            {{$score := $moodItem.Response.Score}}
                            {{$scoreColor := "28a745"}}
                            {{if le $score 4}}{{$scoreColor = "dc3545"}}{{else if le $score 6}}{{$scoreColor = "ffc107"}}{{end}}
                            <div style="text-align: center; margin-bottom: 10px;">
                                <span style="background: #{{$scoreColor}}; color: white; padding: 8px 16px; border-radius: 20px; font-weight: bold; font-size: 20px;">{{$score}}/10</span>
                            </div>
                            {{if and $moodItem.Recommendation $moodItem.Recommendation.Recommendations}}
                                <div style="font-size: 12px; line-height: 1.6; color: rgba(255,255,255,0.95);">
                                    {{$recs := $moodItem.Recommendation.Recommendations}}
                                    {{$cleanRecs := replace $recs "**" ""}}
                                    {{$cleanRecs = replace $cleanRecs "*" ""}}
                                    {{$cleanRecs}}
                                </div>
                            {{end}}
                        </div>
                    {{end}}
                    
                    {{if and $stressItem $stressItem.Response}}
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; backdrop-filter: blur(10px);">
                            <h4 style="margin: 0 0 10px 0; color: white; font-size: 16px;">üò∞ Stress</h4>
                            {{$score := $stressItem.Response.Score}}
                            {{$scoreColor := "28a745"}}
                            {{if le $score 4}}{{$scoreColor = "dc3545"}}{{else if le $score 6}}{{$scoreColor = "ffc107"}}{{end}}
                            <div style="text-align: center; margin-bottom: 10px;">
                                <span style="background: #{{$scoreColor}}; color: white; padding: 8px 16px; border-radius: 20px; font-weight: bold; font-size: 20px;">{{$score}}/10</span>
                            </div>
                            {{if and $stressItem.Recommendation $stressItem.Recommendation.Recommendations}}
                                <div style="font-size: 12px; line-height: 1.6; color: rgba(255,255,255,0.95);">
                                    {{$recs := $stressItem.Recommendation.Recommendations}}
                                    {{$cleanRecs := replace $recs "**" ""}}
                                    {{$cleanRecs = replace $cleanRecs "*" ""}}
                                    {{$cleanRecs}}
                                </div>
                            {{end}}
                        </div>
                    {{end}}
                    
                    {{if and $anxietyItem $anxietyItem.Response}}
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; backdrop-filter: blur(10px);">
                            <h4 style="margin: 0 0 10px 0; color: white; font-size: 16px;">üòü Anxiety</h4>
                            {{$score := $anxietyItem.Response.Score}}
                            {{$scoreColor := "28a745"}}
                            {{if le $score 4}}{{$scoreColor = "dc3545"}}{{else if le $score 6}}{{$scoreColor = "ffc107"}}{{end}}
                            <div style="text-align: center; margin-bottom: 10px;">
                                <span style="background: #{{$scoreColor}}; color: white; padding: 8px 16px; border-radius: 20px; font-weight: bold; font-size: 20px;">{{$score}}/10</span>
                            </div>
                            {{if and $anxietyItem.Recommendation $anxietyItem.Recommendation.Recommendations}}
                                <div style="font-size: 12px; line-height: 1.6; color: rgba(255,255,255,0.95);">
                                    {{$recs := $anxietyItem.Recommendation.Recommendations}}
                                    {{$cleanRecs := replace $recs "**" ""}}
                                    {{$cleanRecs = replace $cleanRecs "*" ""}}
                                    {{$cleanRecs}}
                                </div>
                            {{end}}
                        </div>
                    {{end}}
                    
                    {{if and $wellnessItem $wellnessItem.Response}}
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; backdrop-filter: blur(10px);">
                            <h4 style="margin: 0 0 10px 0; color: white; font-size: 16px;">üíö Wellness</h4>
                            {{$score := $wellnessItem.Response.Score}}
                            {{$scoreColor := "28a745"}}
                            {{if le $score 4}}{{$scoreColor = "dc3545"}}{{else if le $score 6}}{{$scoreColor = "ffc107"}}{{end}}
                            <div style="text-align: center; margin-bottom: 10px;">
                                <span style="background: #{{$scoreColor}}; color: white; padding: 8px 16px; border-radius: 20px; font-weight: bold; font-size: 20px;">{{$score}}/10</span>
                            </div>
                            {{if and $wellnessItem.Recommendation $wellnessItem.Recommendation.Recommendations}}
                                <div style="font-size: 12px; line-height: 1.6; color: rgba(255,255,255,0.95);">
                                    {{$recs := $wellnessItem.Recommendation.Recommendations}}
                                    {{$cleanRecs := replace $recs "**" ""}}
                                    {{$cleanRecs = replace $cleanRecs "*" ""}}
                                    {{$cleanRecs}}
                                </div>
                            {{end}}
                        </div>
                    {{end}}
                {{else}}
                    <div style="grid-column: 1 / -1; text-align: center; padding: 20px;">
                        <p style="margin: 0; opacity: 0.9;">Complete quizzes to see your mental health assessment results here</p>
                        <a href="/quizzes" class="btn-primary" style="margin-top: 15px; display: inline-block; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);">Take a Quiz</a>
                    </div>
                {{end}}
            </div>
        </div>
        {{end}}
        
        <div class="dashboard-grid">
            <div class="card">
                <h2>Submit Feedback</h2>
                <form hx-post="/api/feedback" 
                      hx-target="#feedback-result" 
                      hx-swap="innerHTML"
                      hx-on::after-request="if(event.detail.xhr.status === 200) { this.reset(); htmx.ajax('GET', '/api/feedback', {target: '#feedbacks-list', swap: 'innerHTML'}); }">
                    <div class="form-group">
                        <label for="feedback-type">Type</label>
                        <select id="feedback-type" name="type" required>
                            <option value="general">General</option>
                            <option value="mental_health">Mental Health</option>
                            <option value="campus">Campus Issue</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="feedback-title">Title</label>
                        <input type="text" id="feedback-title" name="title" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="feedback-content">Content</label>
                        <textarea id="feedback-content" name="content" rows="5" required></textarea>
                    </div>
                    
                    <button type="submit" class="btn-primary">Submit Feedback</button>
                </form>
                <div id="feedback-result"></div>
            </div>
            
            <div class="card">
                <h2>My Feedbacks</h2>
                <div id="feedbacks-list">
                    <div class="loading">Loading your feedbacks...</div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2>Quick Actions</h2>
            <div class="action-buttons">
                <a href="/mood" class="btn-primary">Track My Mood</a>
                <a href="/quizzes" class="btn-primary">Take a Quiz</a>
                <a href="/consultation" class="btn-primary">Start Consultation</a>
                <button onclick="saveToken()" class="btn-secondary">Save My Token</button>
            </div>
        </div>
    </main>
    
    <script>
        // Mobile sidebar toggle
        (function() {
            const menuToggle = document.getElementById('menu-toggle');
            const sidebar = document.getElementById('mobile-sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            
            function toggleSidebar() {
                const isActive = sidebar.classList.contains('active');
                sidebar.classList.toggle('active');
                overlay.classList.toggle('active');
                menuToggle.classList.toggle('active');
                document.body.classList.toggle('sidebar-open');
            }
            
            if (menuToggle) {
                menuToggle.addEventListener('click', toggleSidebar);
            }
            
            if (overlay) {
                overlay.addEventListener('click', toggleSidebar);
            }
            
            // Close sidebar when clicking on a link
            if (sidebar) {
                const sidebarLinks = sidebar.querySelectorAll('.sidebar-nav a');
                sidebarLinks.forEach(link => {
                    link.addEventListener('click', function() {
                        if (!this.classList.contains('btn-secondary')) {
                            setTimeout(toggleSidebar, 300);
                        }
                    });
                });
            }
        })();
        
        // Load feedbacks on page load using HTMX
        document.body.addEventListener('htmx:load', function() {
            htmx.ajax('GET', '/api/feedback', {
                target: '#feedbacks-list',
                swap: 'innerHTML'
            });
        });
        
        // Trigger load on page ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                htmx.ajax('GET', '/api/feedback', {
                    target: '#feedbacks-list',
                    swap: 'innerHTML'
                });
                // Load quiz results summary
                loadQuizResultsSummary();
            });
        } else {
            htmx.ajax('GET', '/api/feedback', {
                target: '#feedbacks-list',
                swap: 'innerHTML'
            });
            loadQuizResultsSummary();
        }
        
        function saveToken() {
            alert('Your token is saved in your session. Make sure to save it securely if you want to access your account from another device.');
        }
    </script>
</body>
</html>

