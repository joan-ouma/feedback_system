<div class="quiz-form">
    <h2>{{.quiz.Title}}</h2>
    <p class="quiz-description">{{.quiz.Description}}</p>
    
    <form id="quiz-form">
        <input type="hidden" name="quiz_id" id="quiz-id-input" value="{{.quiz.ID}}">
        <input type="hidden" name="quiz_type" id="quiz-type-input" value="{{.quiz.Type}}">
        
        {{range $qIndex, $question := .quiz.Questions}}
        <div class="quiz-question">
            <label class="question-label">{{$question.Question}}</label>
            {{if eq $question.QuestionType "multiple_choice"}}
                {{range $optIndex, $option := $question.Options}}
                <div class="radio-option">
                    <input type="radio" name="question_{{$question.ID}}" value="{{$option}}" id="q{{$question.ID}}_{{$optIndex}}" required>
                    <label for="q{{$question.ID}}_{{$optIndex}}">{{$option}}</label>
                </div>
                {{end}}
            {{else if eq $question.QuestionType "scale"}}
                <div class="scale-input">
                    <input type="range" name="question_{{$question.ID}}" min="1" max="10" value="5" 
                           oninput="document.getElementById('scale_{{$question.ID}}').textContent = this.value" required>
                    <span id="scale_{{$question.ID}}">5</span>/10
                </div>
            {{else}}
                <textarea name="question_{{$question.ID}}" rows="3" placeholder="Your answer..." required></textarea>
            {{end}}
        </div>
        {{end}}
        
        <button type="submit" class="btn-primary">Submit Quiz</button>
    </form>
</div>

<script>
// Simple quiz submission - no IIFE to avoid redeclaration issues
(function() {
    'use strict';
    
    // Check if already initialized to avoid redeclaration
    if (window.quizFormInitialized) {
        return;
    }
    window.quizFormInitialized = true;
    
    // Helper function to escape HTML
    window.escapeHtml = function(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    };
    
    // Submit quiz function
    window.submitQuiz = function(e) {
        if (e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        const quizForm = document.getElementById('quiz-form');
        if (!quizForm) {
            console.error('Quiz form not found');
            return false;
        }
        
        const formData = new FormData(quizForm);
        const quizId = document.getElementById('quiz-id-input')?.value || formData.get('quiz_id');
        const quizType = document.getElementById('quiz-type-input')?.value || '';
        
        if (!quizId) {
            alert('Quiz ID not found. Please refresh and try again.');
            return false;
        }
        
        const answers = {};
        for (let [key, value] of formData.entries()) {
            if (key !== 'quiz_id' && key !== 'quiz_type') {
                answers[key] = value;
            }
        }
        
        const content = document.getElementById('quiz-content');
        if (!content) {
            alert('Quiz container not found. Please refresh the page.');
            return false;
        }
        
        // Show loading
        content.innerHTML = '<div class="loading" style="padding: 20px; text-align: center;">Submitting quiz...</div>';
        
        // Disable submit button
        const submitBtn = quizForm.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';
        }
        
        // Submit quiz
        fetch('/api/quiz/submit', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'HX-Request': 'true'
            },
            credentials: 'include',
            body: JSON.stringify({
                quiz_id: quizId,
                answers: answers
            })
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => {
                    throw new Error(err.error || 'Server error: ' + response.status);
                });
            }
            return response.json();
        })
        .then(data => {
            // Build results HTML
            let html = '<div class="quiz-results-container" style="padding: 20px;">';
            html += '<div style="text-align: center; margin-bottom: 20px;">';
            html += '<h2 style="color: #007bff; margin-bottom: 10px;">‚úÖ Quiz Completed!</h2>';
            html += '</div>';
            html += '<div class="quiz-result" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">';
            
            // Show score
            if (data.response) {
                const score = data.response.score || 0;
                const result = data.response.result || 'No result available';
                
                let scoreColor = '#28a745'; // green
                if (score <= 4) scoreColor = '#dc3545'; // red
                else if (score <= 6) scoreColor = '#ffc107'; // yellow
                
                html += '<div style="text-align: center; margin-bottom: 15px;">';
                html += '<div style="display: inline-block; background: ' + scoreColor + '; color: white; padding: 10px 20px; border-radius: 20px; font-size: 24px; font-weight: bold;">';
                html += 'Score: ' + score + '/10';
                html += '</div>';
                html += '</div>';
                html += '<p style="text-align: center; font-size: 18px; color: #495057; margin: 10px 0;"><strong>' + window.escapeHtml(result) + '</strong></p>';
            }
            
            // Show recommendations
            if (data.recommendation && data.recommendation.recommendations) {
                let recText = data.recommendation.recommendations;
                
                // Remove markdown formatting
                recText = recText.replace(/\*\*/g, '');
                recText = recText.replace(/\*/g, '');
                recText = recText.replace(/#{1,6}\s/g, '');
                recText = recText.replace(/\[([^\]]+)\]\([^\)]+\)/g, '$1');
                recText = recText.replace(/_{1,2}/g, '');
                recText = recText.replace(/`/g, '');
                recText = recText.replace(/~~/g, '');
                
                // Split into lines
                const recs = recText.split('\n')
                    .map(line => line.trim())
                    .filter(line => line.length > 0 && !line.match(/^[-*‚Ä¢]\s*$/) && !line.match(/^[\s\-*‚Ä¢]+$/));
                
                html += '<div class="recommendations-box" style="margin-top: 20px; padding: 24px; background: linear-gradient(135deg, #e7f3ff 0%, #f0f8ff 100%); border-left: 5px solid #007bff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,123,255,0.1);">';
                html += '<h4 style="margin: 0 0 20px 0; color: #007bff; font-size: 18px; font-weight: 600;">üí° Personalized Recommendations</h4>';
                html += '<div style="color: #495057; line-height: 1.8; font-size: 15px;">';
                
                let recIndex = 0;
                recs.forEach((rec) => {
                    const numberedMatch = rec.match(/^\d+[\.\)]\s*(.+)$/);
                    if (numberedMatch) {
                        recIndex++;
                        const cleanRec = numberedMatch[1].trim();
                        html += '<div style="margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.5); border-radius: 6px;">';
                        html += '<div style="display: flex; align-items: flex-start; gap: 12px;">';
                        html += '<span style="color: #007bff; font-weight: 700; font-size: 20px; line-height: 1;">' + recIndex + '.</span>';
                        html += '<div style="flex: 1; color: #495057;">' + window.escapeHtml(cleanRec) + '</div>';
                        html += '</div></div>';
                    } else if (rec.length > 20) {
                        recIndex++;
                        html += '<div style="margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.5); border-radius: 6px;">';
                        html += '<div style="display: flex; align-items: flex-start; gap: 12px;">';
                        html += '<span style="color: #007bff; font-weight: 700; font-size: 20px; line-height: 1;">' + recIndex + '.</span>';
                        html += '<div style="flex: 1; color: #495057;">' + window.escapeHtml(rec) + '</div>';
                        html += '</div></div>';
                    }
                });
                
                html += '</div></div>';
            }
            
            html += '</div>';
            html += '<div style="text-align: center; margin-top: 20px;">';
            html += '<button onclick="if(typeof loadQuiz !== \'undefined\') { loadQuiz(\'' + quizType + '\'); } else { location.reload(); }" class="btn-primary" style="margin-right: 10px;">Retake Quiz</button>';
            html += '<button onclick="window.location.href=\'/quizzes\'" class="btn-secondary">View All Quizzes</button>';
            html += '</div>';
            html += '</div>';
            
            content.innerHTML = html;
            
            if (submitBtn) {
                submitBtn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Quiz submission error:', error);
            content.innerHTML = '<div class="error" style="padding: 20px; background: #f8d7da; color: #721c24; border-radius: 8px; border: 2px solid #dc3545;">' +
                '<h3 style="margin-top: 0;">‚ùå Error Submitting Quiz</h3>' +
                '<p><strong>' + window.escapeHtml(error.message || 'Failed to submit quiz. Please try again.') + '</strong></p>' +
                '<button onclick="location.reload()" class="btn-primary" style="margin-top: 10px;">Reload Page</button>' +
                '</div>';
            
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Quiz';
            }
        });
        
        return false;
    };
    
    // Retake quiz function
    window.retakeQuiz = function(type) {
        if (typeof loadQuiz !== 'undefined') {
            loadQuiz(type);
        } else {
            window.location.href = '/api/quiz/' + type;
        }
    };
    
    // Attach form listener
    function attachFormListener() {
        const form = document.getElementById('quiz-form');
        if (form && !form.dataset.listenerAttached) {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                e.stopPropagation();
                if (typeof window.submitQuiz === 'function') {
                    return window.submitQuiz(e);
                }
                return false;
            }, { capture: true });
            form.dataset.listenerAttached = 'true';
        }
    }
    
    // Try to attach listener
    attachFormListener();
    setTimeout(attachFormListener, 100);
    setTimeout(attachFormListener, 500);
})();
</script>
