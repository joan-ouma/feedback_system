<div class="quiz-form">
    <h2>{{.quiz.Title}}</h2>
    <p class="quiz-description">{{.quiz.Description}}</p>
    
    <form id="quiz-form" onsubmit="submitQuiz(event)">
        <input type="hidden" name="quiz_id" id="quiz-id-input" value="{{.quiz.ID}}">
        
        {{range $qIndex, $question := .quiz.Questions}}
        <div class="quiz-question">
            <label class="question-label">{{$question.Question}}</label>
            {{if eq $question.QuestionType "multiple_choice"}}
                {{range $optIndex, $option := $question.Options}}
                <div class="radio-option">
                    <input type="radio" name="question_{{$question.ID}}" value="{{$option}}" id="q{{$question.ID}}_{{$optIndex}}" required>
                    <label for="q{{$question.ID}}_{{$optIndex}}">{{$option}}</label>
                </div>
                {{end}}
            {{else if eq $question.QuestionType "scale"}}
                <div class="scale-input">
                    <input type="range" name="question_{{$question.ID}}" min="1" max="10" value="5" 
                           oninput="document.getElementById('scale_{{$question.ID}}').textContent = this.value" required>
                    <span id="scale_{{$question.ID}}">5</span>/10
                </div>
            {{else}}
                <textarea name="question_{{$question.ID}}" rows="3" placeholder="Your answer..." required></textarea>
            {{end}}
        </div>
        {{end}}
        
        <button type="submit" class="btn-primary">Submit Quiz</button>
    </form>
</div>

<script>
function submitQuiz(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    const quizId = document.getElementById('quiz-id-input').value || formData.get('quiz_id');
    const answers = {};
    
    for (let [key, value] of formData.entries()) {
        if (key !== 'quiz_id') {
            answers[key] = value;
        }
    }
    
    // Find the quiz container - try multiple possible IDs
    const content = document.getElementById('quiz-content') || 
                   document.querySelector('.quiz-form') || 
                   document.querySelector('main') ||
                   document.body;
    
    const originalContent = content.innerHTML;
    content.innerHTML = '<div class="loading">Submitting quiz...</div>';
    
    fetch('/api/quiz/submit', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'HX-Request': 'true'
        },
        credentials: 'include',
        body: JSON.stringify({
            quiz_id: quizId,
            answers: answers
        })
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => Promise.reject(err));
        }
        return response.json();
    })
    .then(data => {
        console.log('Quiz response data:', data);
        
        let html = `
            <div class="quiz-results-container">
                <h2>Quiz Results</h2>
                <div class="quiz-result">
        `;
        
        if (data.response) {
            html += `
                <p><strong>Score:</strong> ${data.response.score || 'N/A'}</p>
                <p><strong>Result:</strong> ${data.response.result || 'No result available'}</p>
            `;
        } else {
            html += `<p>Quiz submitted successfully!</p>`;
        }
        
        if (data.recommendation && data.recommendation.recommendations) {
            html += `
                <div class="recommendations-box" style="margin-top: 20px; padding: 15px; background: #f0f8ff; border-left: 4px solid #007bff; border-radius: 4px;">
                    <h4 style="margin-top: 0;">Personalized Recommendations:</h4>
                    <div class="recommendations-content" style="white-space: pre-wrap;">${escapeHtml(data.recommendation.recommendations)}</div>
                </div>
            `;
        } else {
            html += `
                <div class="recommendations-box" style="margin-top: 20px; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">
                    <p style="margin: 0; color: #856404;">Recommendations are being generated. Please check back later or refresh the page.</p>
                </div>
            `;
        }
        
        html += `
                </div>
                <a href="/quizzes" class="btn-primary" style="margin-top: 20px; display: inline-block;">Take Another Quiz</a>
            </div>
        `;
        
        content.innerHTML = html;
    })
    .catch(error => {
        console.error('Error submitting quiz:', error);
        let errorMsg = 'Failed to submit quiz. Please try again.';
        if (error.error) {
            errorMsg = error.error;
        } else if (error.message) {
            errorMsg = error.message;
        }
        content.innerHTML = `<div class="error" style="padding: 15px; background: #f8d7da; color: #721c24; border-radius: 4px;">${escapeHtml(errorMsg)}</div>`;
    });
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>

