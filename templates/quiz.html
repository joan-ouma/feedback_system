<div class="quiz-form">
    <h2>{{.quiz.Title}}</h2>
    <p class="quiz-description">{{.quiz.Description}}</p>
    
    <form id="quiz-form" onsubmit="return submitQuiz(event)">
        <input type="hidden" name="quiz_id" id="quiz-id-input" value="{{.quiz.ID}}">
        <input type="hidden" name="quiz_type" id="quiz-type-input" value="{{.quiz.Type}}">
        
        {{range $qIndex, $question := .quiz.Questions}}
        <div class="quiz-question">
            <label class="question-label">{{$question.Question}}</label>
            {{if eq $question.QuestionType "multiple_choice"}}
                {{range $optIndex, $option := $question.Options}}
                <div class="radio-option">
                    <input type="radio" name="question_{{$question.ID}}" value="{{$option}}" id="q{{$question.ID}}_{{$optIndex}}" required>
                    <label for="q{{$question.ID}}_{{$optIndex}}">{{$option}}</label>
                </div>
                {{end}}
            {{else if eq $question.QuestionType "scale"}}
                <div class="scale-input">
                    <input type="range" name="question_{{$question.ID}}" min="1" max="10" value="5" 
                           oninput="document.getElementById('scale_{{$question.ID}}').textContent = this.value" required>
                    <span id="scale_{{$question.ID}}">5</span>/10
                </div>
            {{else}}
                <textarea name="question_{{$question.ID}}" rows="3" placeholder="Your answer..." required></textarea>
            {{end}}
        </div>
        {{end}}
        
        <button type="submit" class="btn-primary">Submit Quiz</button>
    </form>
</div>

<script>
function submitQuiz(e) {
    e.preventDefault();
    e.stopPropagation();
    
    const form = e.target;
    const formData = new FormData(form);
    const quizId = document.getElementById('quiz-id-input').value || formData.get('quiz_id');
    const quizType = document.getElementById('quiz-type-input').value || '';
    const answers = {};
    
    for (let [key, value] of formData.entries()) {
        if (key !== 'quiz_id' && key !== 'quiz_type') {
            answers[key] = value;
        }
    }
    
    // ALWAYS update quiz-content div - this is where the quiz is displayed
    const content = document.getElementById('quiz-content');
    if (!content) {
        console.error('quiz-content div not found!');
        return false;
    }
    
    // Store original content in case we need to restore
    const originalContent = content.innerHTML;
    content.innerHTML = '<div class="loading">Submitting quiz...</div>';
    
    // Disable submit button to prevent double submission
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalBtnText = submitBtn ? submitBtn.textContent : '';
    if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';
    }
    
    fetch('/api/quiz/submit', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'HX-Request': 'true'
        },
        credentials: 'include',
        body: JSON.stringify({
            quiz_id: quizId,
            answers: answers
        })
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => Promise.reject(err));
        }
        return response.json();
    })
    .then(data => {
        console.log('Quiz response data:', data);
        
        let html = `
            <div class="quiz-results-container" style="padding: 20px;">
                <div style="text-align: center; margin-bottom: 20px;">
                    <h2 style="color: #007bff; margin-bottom: 10px;">‚úÖ Quiz Completed!</h2>
                </div>
                <div class="quiz-result" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
        `;
        
        if (data.response) {
            const score = data.response.score || 0;
            const result = data.response.result || 'No result available';
            
            // Score badge with color coding
            let scoreColor = '#28a745'; // green
            if (score <= 4) scoreColor = '#dc3545'; // red
            else if (score <= 6) scoreColor = '#ffc107'; // yellow
            
            html += `
                <div style="text-align: center; margin-bottom: 15px;">
                    <div style="display: inline-block; background: ${scoreColor}; color: white; padding: 10px 20px; border-radius: 20px; font-size: 24px; font-weight: bold;">
                        Score: ${score}/10
                    </div>
                </div>
                <p style="text-align: center; font-size: 18px; color: #495057; margin: 10px 0;"><strong>${escapeHtml(result)}</strong></p>
            `;
        } else {
            html += `<p>Quiz submitted successfully!</p>`;
        }
        
        if (data.recommendation && data.recommendation.recommendations) {
            // Format recommendations as clean, professional text
            let recText = data.recommendation.recommendations;
            
            // Remove markdown formatting (**bold**, *italic*, etc.)
            recText = recText.replace(/\*\*/g, ''); // Remove **
            recText = recText.replace(/\*/g, ''); // Remove single *
            recText = recText.replace(/#{1,6}\s/g, ''); // Remove markdown headers
            recText = recText.replace(/\[([^\]]+)\]\([^\)]+\)/g, '$1'); // Remove markdown links
            
            // Split into lines and clean up
            const recs = recText.split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0 && !line.match(/^[-*]\s*$/)); // Remove empty lines and single dashes/asterisks
            
            html += `
                <div class="recommendations-box" style="margin-top: 20px; padding: 24px; background: linear-gradient(135deg, #e7f3ff 0%, #f0f8ff 100%); border-left: 5px solid #007bff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,123,255,0.1);">
                    <h4 style="margin: 0 0 16px 0; color: #007bff; font-size: 18px; font-weight: 600;">üí° Personalized Recommendations</h4>
                    <div style="color: #495057; line-height: 1.7; font-size: 15px;">
            `;
            
            // Display as clean paragraphs or numbered list
            let isNumbered = false;
            recs.forEach((rec, index) => {
                // Check if it's a numbered list
                if (rec.match(/^\d+[\.\)]\s/)) {
                    isNumbered = true;
                    let cleanRec = rec.replace(/^\d+[\.\)]\s*/, '').trim();
                    if (cleanRec.length > 0) {
                        html += `<div style="margin-bottom: 12px; padding-left: 8px;"><span style="color: #007bff; font-weight: 600;">${index + 1}.</span> <span style="color: #495057;">${escapeHtml(cleanRec)}</span></div>`;
                    }
                } else if (rec.match(/^[-*‚Ä¢]\s/)) {
                    // Bullet points
                    let cleanRec = rec.replace(/^[-*‚Ä¢]\s*/, '').trim();
                    if (cleanRec.length > 0) {
                        html += `<div style="margin-bottom: 12px; padding-left: 20px; position: relative;"><span style="position: absolute; left: 0; color: #007bff;">‚Ä¢</span> <span style="color: #495057;">${escapeHtml(cleanRec)}</span></div>`;
                    }
                } else {
                    // Regular paragraph
                    if (rec.length > 0) {
                        html += `<div style="margin-bottom: 12px; color: #495057;">${escapeHtml(rec)}</div>`;
                    }
                }
            });
            
            html += `
                    </div>
                </div>
            `;
        } else {
            html += `
                <div class="recommendations-box" style="margin-top: 20px; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">
                    <p style="margin: 0; color: #856404;">‚è≥ Recommendations are being generated. Please refresh the quizzes page to see them.</p>
                </div>
            `;
        }
        
        html += `
                </div>
                <div style="text-align: center;">
                    <button onclick="retakeQuiz('${quizType}')" class="btn-primary" style="margin-right: 10px;">Retake Quiz</button>
                    <button onclick="window.location.href='/quizzes'" class="btn-secondary">View All Quizzes</button>
                </div>
            </div>
        `;
        
        // Update the quiz-content div with results - NO PAGE RELOAD
        content.innerHTML = html;
        
        // Re-enable submit button (if it still exists in DOM)
        const btn = form.querySelector('button[type="submit"]');
        if (btn) {
            btn.disabled = false;
        }
        
        // Store flag that quiz was submitted (for when user manually navigates to quizzes page)
        if (typeof sessionStorage !== 'undefined') {
            sessionStorage.setItem('quiz-just-submitted', 'true');
        }
        
        // DO NOT reload page - results stay inline
        // User can manually click "View All Quizzes" if they want to see updated scores
        
        return false; // Prevent any form submission
    })
    .catch(error => {
        console.error('Error submitting quiz:', error);
        let errorMsg = 'Failed to submit quiz. Please try again.';
        if (error.error) {
            errorMsg = error.error;
        } else if (error.message) {
            errorMsg = error.message;
        }
        content.innerHTML = `<div class="error" style="padding: 15px; background: #f8d7da; color: #721c24; border-radius: 4px;">${escapeHtml(errorMsg)}</div>`;
        
        // Re-enable submit button on error
        const btn = form.querySelector('button[type="submit"]');
        if (btn) {
            btn.disabled = false;
            btn.textContent = originalBtnText || 'Submit Quiz';
        }
        
        return false; // Prevent any form submission
    });
    
    return false; // Prevent form submission
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function retakeQuiz(type) {
    // Check if we're in the quiz list page
    if (typeof loadQuiz !== 'undefined') {
        loadQuiz(type);
    } else {
        // Otherwise reload the quiz
        window.location.href = '/api/quiz/' + type;
    }
}
</script>

